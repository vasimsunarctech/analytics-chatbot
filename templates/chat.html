{% extends "base.html" %}

{% block title %}Chat | TAS Chat{% endblock %}

{% block main_class %}pt-6 pb-0{% endblock %}

{% block content %}
<div
    x-data='chatComponent({{ messages_data|tojson|safe }}, {{ selected_session.id }})'
    x-init="init()"
    class="space-y-6"
>
    <section class="flex flex-col rounded-lg bg-white shadow min-h-[calc(100vh-6rem)]">
        <header class="border-b border-gray-200 px-6 py-4">
            <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-lg font-semibold text-gray-800">{{ selected_session.session_name }}</h1>
                    <p class="text-sm text-gray-500">Use the menu above to start a new session or browse chat history.</p>
                </div>
                <button type="button" data-open-new-session class="hidden rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 md:inline-flex">New Session</button>
            </div>
        </header>
        <div x-ref="chatContainer" class="flex-1 overflow-y-auto px-6 py-6">
            <template x-if="messages.length === 0">
                <p class="text-sm text-gray-500">No messages yet. Say hello!</p>
            </template>
            <template x-for="msg in messages" :key="msg.id">
                <div class="flex mb-5" :class="msg.sender === 'user' ? 'justify-end' : 'justify-start'">
                    <div class="max-w-xl rounded-2xl px-4 py-3 text-sm shadow-sm" :class="msg.sender === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800'">
                        <p class="whitespace-pre-wrap" x-text="msg.message_text"></p>
                        <template x-if="msg.metadata && msg.metadata.rows && msg.metadata.rows.length">
                            <div class="mt-3 overflow-x-auto rounded-md bg-white/80 p-3 text-gray-800">
                                <table class="min-w-full text-xs">
                                    <thead>
                                        <tr>
                                            <template x-for="column in msg.metadata.columns" :key="column">
                                                <th class="px-2 py-1 text-left font-semibold text-gray-600" x-text="column"></th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="(row, rowIndex) in msg.metadata.rows" :key="rowIndex">
                                            <tr class="border-t border-gray-200">
                                                <template x-for="column in msg.metadata.columns" :key="column">
                                                    <td class="px-2 py-1 text-gray-700" x-text="row[column] !== null && row[column] !== undefined ? row[column] : 'â€”'"></td>
                                                </template>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>
                        <template x-if="msg.metadata && msg.metadata.chart">
                            <div class="mt-4 h-64">
                                <canvas :id="`chart-${msg.id}`" class="h-full w-full"></canvas>
                            </div>
                        </template>
                        <span class="mt-2 block text-xs opacity-70" x-text="msg.formatted_timestamp"></span>
                    </div>
                </div>
            </template>
        </div>
        <footer class="border-t border-gray-200 px-6 py-4">
            <form @submit.prevent="send" action="{{ url_for('send_message') }}" method="post" class="flex flex-col gap-3 md:flex-row">
                <input type="hidden" name="session_id" value="{{ selected_session.id }}" :value="sessionId">
                <textarea
                    name="message"
                    x-model="messageText"
                    x-ref="chatInput"
                    rows="2"
                    placeholder="Ask something..."
                    required
                    class="w-full resize-none rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                    @keydown.enter="if (!$event.shiftKey) { $event.preventDefault(); send(); }"
                ></textarea>
                <button
                    type="submit"
                    class="rounded-md bg-blue-600 px-5 py-2 text-sm font-medium text-white hover:bg-blue-700"
                    :class="isSending ? 'cursor-not-allowed opacity-70' : ''"
                    :disabled="isSending"
                >
                    <span x-show="!isSending" x-cloak>Send</span>
                    <span x-show="isSending" x-cloak>Sending...</span>
                </button>
            </form>
        </footer>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('chatComponent', (initialMessages, sessionId) => ({
            messages: initialMessages,
            sessionId,
            messageText: '',
            isSending: false,
            renderedCharts: {},
            init() {
                this.$watch('messages', () => {
                    this.$nextTick(() => this.renderCharts());
                });
                this.$nextTick(() => {
                    this.scrollToBottom();
                    if (this.$refs.chatInput) {
                        this.$refs.chatInput.focus();
                    }
                    this.renderCharts();
                });
            },
            scrollToBottom() {
                if (this.$refs.chatContainer) {
                    this.$refs.chatContainer.scrollTop = this.$refs.chatContainer.scrollHeight;
                }
            },
            renderCharts() {
                if (typeof Chart === 'undefined') {
                    return;
                }
                requestAnimationFrame(() => {
                    this.messages.forEach((msg) => {
                        const chartConfig = msg.metadata && msg.metadata.chart;
                        if (!chartConfig) {
                            return;
                        }
                        const canvasId = `chart-${msg.id}`;
                        if (this.renderedCharts[canvasId]) {
                            return;
                        }
                        const canvas = document.getElementById(canvasId);
                        if (!canvas) {
                            return;
                        }
                        const ctx = canvas.getContext('2d');
                        this.renderedCharts[canvasId] = new Chart(ctx, {
                            type: chartConfig.type || 'bar',
                            data: {
                                labels: chartConfig.labels,
                                datasets: [
                                    {
                                        label: chartConfig.label || 'Value',
                                        data: chartConfig.data,
                                        backgroundColor: '#2563eb',
                                        borderRadius: 4,
                                    },
                                ],
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                    },
                                },
                            },
                        });
                    });
                });
            },
            async send() {
                const text = this.messageText.trim();
                if (!text || this.isSending) {
                    return;
                }

                this.isSending = true;

                try {
                    const response = await fetch('{{ url_for("api_send_message") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        body: JSON.stringify({ session_id: this.sessionId, message: text }),
                    });

                    const data = await response.json();
                    if (!response.ok || data.status !== 'ok') {
                        throw new Error(data.error || 'Failed to send message');
                    }

                    data.messages.forEach((msg) => this.messages.push(msg));
                    this.messageText = '';

                    this.$nextTick(() => {
                        this.scrollToBottom();
                        if (this.$refs.chatInput) {
                            this.$refs.chatInput.focus();
                        }
                        this.renderCharts();
                    });
                } catch (error) {
                    console.error(error);
                    alert('Unable to send message right now. Reloading chat.');
                    window.location.reload();
                } finally {
                    this.isSending = false;
                }
            },
        }));
    });
</script>
{% endblock %}
